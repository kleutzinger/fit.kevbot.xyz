<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.css"
/>
<script src="//unpkg.com/alpinejs" defer></script>

<select
  id="machine_id"
  hx-get="/machine-name-options"
  hx-trigger="load"
  hx-swap="innerHTML"
  hx-target="this"
></select>
<select
  id="column"
  hx-get="/machine-column-options"
  hx-trigger="load"
  hx-swap="innerHTML"
  hx-target="this"
></select>
<div id="butt"></div>

<div id="chart"></div>
<script>
  (async () => {
    // init chart
    var chart = c3.generate({
      bindto: "#chart",
      data: {
        columns: [],
      },
    });
    var resp = await fetch("/download-json");
    var json = await resp.json();
    const all_workouts = json.workouts;
    all_workouts.sort(function (a, b) {
      return new Date(a.datetime) - new Date(b.datetime);
    });
    function workoutsToChart() {
      const machine_id = document.getElementById("machine_id").value;
      const column = document.getElementById("column").value;
      var workouts = all_workouts.filter(function (e) {
        return e.machine_id == machine_id;
      });
      var labels = workouts.map(function (e) {
        return new Date(e.datetime).toLocaleDateString();
      });
      var data = workouts.map(function (e) {
        return e[column];
      });
      // init chart
      chart.load({
        columns: [labels, data],
      });
    }
    workoutsToChart();

    // add button to dom to execute workoutsToChart
    var button = document.createElement("button");
    button.innerHTML = "Update Chart";
    button.onclick = workoutsToChart;
    document.getElementById("butt").appendChild(button);
    // add onchange to both selects also
    document.getElementById("machine_id").onchange = workoutsToChart;
    document.getElementById("column").onchange = workoutsToChart;
  })();
</script>
